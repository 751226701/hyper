<include file="public@header"/>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-row">
        <div class="layui-card">
            <div class="layui-tab layui-tab-brief js-check-wrap">
                <ul class="layui-tab-title">
                    <li class="layui-this"><a href="javascript:;">文章管理</a></li>
                    <li><a href="{:url('AdminArticle/add')}">添加文章</a></li>
                </ul>
                <div class="layui-tab-content">
                    <form class="layui-form layui-form-pane" method="get" action="{:url('AdminArticle/index')}">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">分类:</label>
                                <div class="layui-input-inline" style="width: 140px;">
                                    <select class="layui-select" name="category">
                                        <option value='0'>全部</option>
                                        {$category_tree|default=''}
                                    </select>
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">时间:</label>
                                <div class="layui-input-inline" style="width: 140px;">
                                    <input type="text" class="layui-input" id="startTime" name="start_time"
                                           value="{$start_time|default=''}" autocomplete="off" placeholder="开始时间">
                                </div>
                                <div class="layui-form-mid">-</div>
                                <div class="layui-input-inline" style="width: 140px;">
                                    <input type="text" class="layui-input" id="endTime" name="end_time"
                                           value="{$end_time|default=''}" autocomplete="off" placeholder="结束时间">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <label class="layui-form-label">关键字:</label>
                                <div class="layui-input-inline" style="width: 200px;">
                                    <input type="text" class="layui-input" name="keyword" 
                                           value="{$keyword|default=''}" placeholder="请输入关键字...">
                                </div>
                                <div class="layui-input-inline" style="margin-right: 0;">
                                    <button class="layui-btn" type="submit"><i class="layui-icon layui-icon-search"></i>搜索</button>
                                    <a class="layui-btn layui-btn-danger" href="{:url('AdminArticle/index')}">清空</a>
                                </div>
                            </div>
                        </div>
                    </form>

                    <form class="js-ajax-form layui-form" action="" method="post">
                        <div class="layui-btn-group">
                            <notempty name="category">
                                <button class="layui-btn layui-btn-xs js-ajax-submit" type="submit"
                                        data-action="{:url('AdminArticle/listOrder')}">
                                    <i class="layui-icon layui-icon-sort"></i> {:lang('SORT')}
                                </button>
                            </notempty>
                            <button class="layui-btn layui-btn-xs layui-btn-normal js-ajax-submit" type="submit"
                                    data-action="{:url('AdminArticle/publish',array('yes'=>1))}" data-subcheck="true">
                                <i class="layui-icon layui-icon-release"></i> 发布
                            </button>
                            <button class="layui-btn layui-btn-xs layui-btn-warm js-ajax-submit" type="submit"
                                    data-action="{:url('AdminArticle/publish',array('no'=>1))}" data-subcheck="true">
                                <i class="layui-icon layui-icon-close"></i> 取消发布
                            </button>
                            <button class="layui-btn layui-btn-xs js-ajax-submit" type="submit"
                                    data-action="{:url('AdminArticle/top',array('yes'=>1))}" data-subcheck="true">
                                <i class="layui-icon layui-icon-top"></i> 置顶
                            </button>
                            <button class="layui-btn layui-btn-xs layui-btn-warm js-ajax-submit" type="submit"
                                    data-action="{:url('AdminArticle/top',array('no'=>1))}" data-subcheck="true">
                                <i class="layui-icon layui-icon-down"></i> 取消置顶
                            </button>
                            <button class="layui-btn layui-btn-xs js-ajax-submit" type="submit"
                                    data-action="{:url('AdminArticle/recommend',array('yes'=>1))}" data-subcheck="true">
                                <i class="layui-icon layui-icon-praise"></i> 推荐
                            </button>
                            <button class="layui-btn layui-btn-xs layui-btn-warm js-ajax-submit" type="submit"
                                    data-action="{:url('AdminArticle/recommend',array('no'=>1))}" data-subcheck="true">
                                <i class="layui-icon layui-icon-tread"></i> 取消推荐
                            </button>
                            <button class="layui-btn layui-btn-xs layui-btn-danger js-ajax-submit" type="submit"
                                    data-action="{:url('AdminArticle/delete')}" data-subcheck="true" 
                                    data-msg="您确定删除除吗？">
                                <i class="layui-icon layui-icon-delete"></i> {:lang('DELETE')}
                            </button>
                        </div>

                        <table class="layui-table">
                            <thead>
                                <tr>
                                    <th width="16">
                                        <input type="checkbox" lay-skin="primary" lay-filter="allChoose" class="js-check-all" data-direction="x" data-checklist="js-check-x">
                                    </th>
                                    <notempty name="category">
                                        <th width="50">{:lang('SORT')}</th>
                                    </notempty>
                                    <th>标题</th>
                                    <th>分类</th>
                                    <th width="80">作者</th>
                                    <th width="80">点击量</th>
                                    <th width="80">评论量</th>
                                    <th width="160">关键字/来源<br>摘要/缩略图</th>
                                    <th width="160">更新时间</th>
                                    <th width="160">发布时间</th>
                                    <th width="150">状态</th>
                                    <th width="120">操作</th>
                                </tr>
                            </thead>
                            <tbody>
                            <foreach name="articles" item="vo">
                                <tr>
                                    <td>
                                        <input type="checkbox" lay-skin="primary" class="js-check" data-yid="js-check-y" data-xid="js-check-x" name="ids[]" value="{$vo.id}">
                                    </td>
                                    <notempty name="category">
                                        <td>
                                            <input name="list_orders[{$vo.post_category_id}]" class="layui-input layui-input-sm" 
                                                   type="text" value="{$vo.list_order}">
                                        </td>
                                    </notempty>
                                    <td>
                                        <notempty name="category">
                                            <a href="{:cmf_url('portal/Article/index',array('id'=>$vo['id'],'cid'=>$vo['category_id']))}"
                                               target="_blank">{$vo.post_title}</a>
                                        <else/>
                                            <a href="{:cmf_url('portal/Article/index',array('id'=>$vo['id']))}"
                                               target="_blank">{$vo.post_title}</a>
                                        </notempty>
                                    </td>
                                    <td>
                                        <foreach name="vo.categories" item="voo">
                                            <span class="layui-badge layui-bg-blue">
                                                <a href="{:cmf_url('portal/List/index',array('id'=>$voo['id']))}"
                                                   target="_blank" style="color: white;">{$voo.name}</a>
                                            </span>
                                        </foreach>
                                    </td>
                                    <td>{$vo.user_nickname}</td>
                                    <td>{$vo.post_hits|default=0}</td>
                                    <td>{$vo.comment_count|default='0'}</td>
                                    <td>
                                        <notempty name="vo.post_keywords">
                                            <i class="layui-icon layui-icon-ok"></i>
                                        <else/>
                                            <i class="layui-icon layui-icon-close"></i>
                                        </notempty>
                                        <notempty name="vo.post_source">
                                            <i class="layui-icon layui-icon-ok"></i>
                                        <else/>
                                            <i class="layui-icon layui-icon-close"></i>
                                        </notempty>
                                        <notempty name="vo.post_excerpt">
                                            <i class="layui-icon layui-icon-ok"></i>
                                        <else/>
                                            <i class="layui-icon layui-icon-close"></i>
                                        </notempty>
                                        <notempty name="vo.more.thumbnail">
                                            <a href="javascript:parent.imagePreviewDialog('{:cmf_get_image_preview_url($vo.more.thumbnail)}');">
                                                <i class="layui-icon layui-icon-picture"></i>
                                            </a>
                                        <else/>
                                            <i class="layui-icon layui-icon-close"></i>
                                        </notempty>
                                    </td>
                                    <td>
                                        <notempty name="vo.update_time">
                                            {:date('Y-m-d H:i',$vo['update_time'])}
                                        </notempty>
                                    </td>
                                    <td>
                                        <empty name="vo.published_time">
                                            未发布
                                        <else/>
                                            {:date('Y-m-d H:i',$vo['published_time'])}
                                        </empty>
                                    </td>
                                    <td>
                                        <notempty name="vo.post_status">
                                            <span class="layui-badge layui-bg-green" title="已发布">
                                                <i class="layui-icon layui-icon-ok"></i>
                                            </span>
                                        <else/>
                                            <span class="layui-badge layui-bg-gray" title="未发布">
                                                <i class="layui-icon layui-icon-close"></i>
                                            </span>
                                        </notempty>
                                        <notempty name="vo.is_top">
                                            <span class="layui-badge" title="已置顶">
                                                <i class="layui-icon layui-icon-top"></i>
                                            </span>
                                        <else/>
                                            <span class="layui-badge layui-bg-gray" title="未置顶">
                                                <i class="layui-icon layui-icon-down"></i>
                                            </span>
                                        </notempty>
                                        <notempty name="vo.recommended">
                                            <span class="layui-badge layui-bg-blue" title="已推荐">
                                                <i class="layui-icon layui-icon-praise"></i>
                                            </span>
                                        <else/>
                                            <span class="layui-badge layui-bg-gray" title="未推荐">
                                                <i class="layui-icon layui-icon-tread"></i>
                                            </span>
                                        </notempty>
                                    </td>
                                    <td>
                                        <a class="layui-btn layui-btn-xs" href="{:url('AdminArticle/edit',array('id'=>$vo['id']))}">
                                            <i class="layui-icon layui-icon-edit"></i>
                                        </a>
                                        <a class="layui-btn layui-btn-xs layui-btn-danger js-ajax-delete"
                                           href="{:url('AdminArticle/delete',array('id'=>$vo['id']))}">
                                            <i class="layui-icon layui-icon-delete"></i>
                                        </a>
                                    </td>
                                </tr>
                            </foreach>
                            </tbody>
                        </table>
                        <div class="pagination">{$page|default=''}</div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="__STATIC__/js/admin.js?v={$_static_version}"></script>
<script>
layui.use(['form', 'laydate'], function(){
    var form = layui.form,
        laydate = layui.laydate;
    
    // 日期时间范围
    laydate.render({
        elem: '#startTime',
        type: 'datetime'
    });
    
    laydate.render({
        elem: '#endTime',
        type: 'datetime'
    });
    
    // 全选
    form.on('checkbox(allChoose)', function(data){
        var child = $(data.elem).closest('table').find('tbody input[type="checkbox"]');
        child.each(function(index, item){
            item.checked = data.elem.checked;
        });
        form.render('checkbox');
    });
});

function openPortalArticleEditDialog(obj) {
    var $obj = $(obj);
    var href = $obj.data('href');
    parent.openIframeLayer(href, '编辑文章', {
        area: GV.IS_MOBILE ? ['100%', '100%'] : ['95%', '95%'],
        offset: GV.IS_MOBILE ? ['0px', '0px'] : 'auto',
        end: function () {
            location.reload();
        }
    });
}
</script>
</body>
</html>
