<include file="public@header"/>
<style>
    #menus-table td:nth-child(3) {
        display: none
    }

    #menus-table th:nth-child(3) {
        display: none
    }
</style>
</head>
<body>
<div class="layui-fluid">
    <div class="layui-row">
        <div class="layui-card">
            <div class="layui-tab layui-tab-brief js-check-wrap">
                <ul class="layui-tab-title">
                    <li class="layui-this"><a href="{:url('AdminCategory/index')}">分类管理</a></li>
                    <li><a href="{:url('AdminCategory/add')}">添加分类</a></li>
                </ul>
                <div class="layui-tab-content">
                    <!-- 搜索表单 -->
                    <form class="layui-form layui-form-pane" method="get" action="{:url('AdminCategory/index')}">
                        <div class="layui-form-item">
                            <div class="layui-inline">
                                <label class="layui-form-label">分类名称</label>
                                <div class="layui-input-inline">
                                    <input type="text" class="layui-input" name="keyword" value="{$keyword|default=''}" 
                                           placeholder="请输入分类名称">
                                </div>
                            </div>
                            <div class="layui-inline">
                                <button class="layui-btn" type="submit"><i class="layui-icon layui-icon-search"></i>搜索</button>
                                <a class="layui-btn layui-btn-danger" href="{:url('AdminCategory/index')}">清空</a>
                            </div>
                        </div>
                    </form>

                    <!-- 数据表格 -->
                    <form method="post" class="js-ajax-form layui-form" action="{:url('AdminCategory/listOrder')}">
                        <div class="layui-btn-group">
                            <button type="submit" class="layui-btn layui-btn-xs js-ajax-submit">
                                <i class="layui-icon layui-icon-sort"></i> {:lang('SORT')}
                            </button>
                            <button class="layui-btn layui-btn-xs layui-btn-normal js-ajax-submit" type="submit"
                                    data-action="{:url('AdminCategory/toggle',array('display'=>'1'))}" data-subcheck="true">
                                <i class="layui-icon layui-icon-ok"></i> {:lang('DISPLAY')}
                            </button>
                            <button class="layui-btn layui-btn-xs layui-btn-warm js-ajax-submit" type="submit"
                                    data-action="{:url('AdminCategory/toggle',array('hide'=>1))}" data-subcheck="true">
                                <i class="layui-icon layui-icon-close"></i> {:lang('HIDE')}
                            </button>
                        </div>

                        <empty name="keyword">
                            <table class="layui-table" id="menus-table">
                                <thead>
                                    <tr>
                                        <th width="16">
                                            <input type="checkbox" lay-skin="primary" lay-filter="allChoose" class="js-check-all" data-direction="x" data-checklist="js-check-x">
                                        </th>
                                        <th width="100">排序</th>
                                        <th width="50">ID</th>
                                        <th>分类名称</th>
                                        <th>描述</th>
                                        <th width="200">模板文件</th>
                                        <th>状态</th>
                                        <th width="250">操作</th>
                                    </tr>
                                </thead>
                                {$category_tree}
                            </table>
                        <else/>
                            <table class="layui-table">
                                <thead>
                                    <tr>
                                        <th width="16">
                                            <input type="checkbox" lay-skin="primary" lay-filter="allChoose" class="js-check-all" data-direction="x" data-checklist="js-check-x">
                                        </th>
                                        <th width="100">排序</th>
                                        <th>分类名称</th>
                                        <th>描述</th>
                                        <th width="200">模板文件</th>
                                        <th>状态</th>
                                        <th width="250">操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                <foreach name="categories" item="vo">
                                    <tr>
                                        <td>
                                            <input type="checkbox" lay-skin="primary" class="js-check" 
                                                   data-yid="js-check-y" data-xid="js-check-x" name="ids[]" value="{$vo.id}">
                                        </td>
                                        <td>
                                            <input name="list_orders[{$vo.id}]" class="layui-input layui-input-sm" type="text"
                                            value="{$vo.list_order}">
                                        </td>
                                        <td>
                                            <a href="{cmf_url('portal/List/index',['id'=>$vo['id']])}" target="_blank">{$vo.name}</a>
                                        </td>
                                        <td>{$vo.description}</td>
                                        <td>
                                            <empty name="vo.status">
                                                <span class="layui-badge layui-bg-orange">隐藏</span>
                                            <else/>
                                                <span class="layui-badge layui-bg-green">显示</span>
                                            </empty>
                                        </td>
                                        <td>
                                            <div class="layui-btn-group">
                                                <a class="layui-btn layui-btn-xs" 
                                                   href="{:url('AdminCategory/add',['parent'=>$vo.id])}">
                                                    <i class="layui-icon layui-icon-add-1"></i>添加子分类
                                                </a>
                                                <a class="layui-btn layui-btn-xs layui-btn-normal" 
                                                   href="{:url('AdminCategory/edit',['id'=>$vo.id])}">
                                                    <i class="layui-icon layui-icon-edit"></i>编辑
                                                </a>
                                                <a class="layui-btn layui-btn-xs layui-btn-danger js-ajax-delete" 
                                                   href="{:url('AdminCategory/delete',['id'=>$vo.id])}">
                                                    <i class="layui-icon layui-icon-delete"></i>删除
                                                </a>
                                                <empty name="vo.status">
                                                    <a class="layui-btn layui-btn-xs layui-btn-normal js-ajax-dialog-btn" 
                                                       data-msg="您确定显示此分类吗"
                                                       href="{:url('AdminCategory/toggle',['ids'=>$vo.id,'display'=>1])}">
                                                        <i class="layui-icon layui-icon-ok"></i>显示
                                                    </a>
                                                <else/>
                                                    <a class="layui-btn layui-btn-xs layui-btn-warm js-ajax-dialog-btn" 
                                                       data-msg="您确定隐藏此分类吗"
                                                       href="{:url('AdminCategory/toggle',['ids'=>$vo.id,'hide'=>1])}">
                                                        <i class="layui-icon layui-icon-close"></i>隐藏
                                                    </a>
                                                </empty>
                                            </div>
                                        </td>
                                    </tr>
                                </foreach>
                                </tbody>
                            </table>
                        </empty>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="__STATIC__/js/admin.js?v={$_static_version}"></script>
<script>
    $(document).ready(function () {
        Wind.css('treeTable');
        Wind.use('treeTable', function () {
            $("#menus-table").treeTable({
                indent: 20,
                initialState: 'expanded'
            });
        });
    });
</script>
<script>
layui.use(['form'], function(){
    var form = layui.form;
    
    // 全选
    form.on('checkbox(allChoose)', function(data){
        var child = $(data.elem).closest('table').find('tbody input[type="checkbox"]');
        child.each(function(index, item){
            item.checked = data.elem.checked;
        });
        form.render('checkbox');
    });

    // 给所有checkbox添加lay-skin属性
    $('input[type="checkbox"]').attr('lay-skin', 'primary');
    
    // 给所有js-check类的checkbox添加lay-filter属性
    $('.js-check').attr('lay-filter', 'itemChoose');
    
    // 重新渲染表单元素
    form.render();
    
    // 监听单个选择
    form.on('checkbox(itemChoose)', function(data){
        // 更新全选框状态
        var checkedCount = $('.js-check:checked').length;
        var totalCount = $('.js-check').length;
        var allCheckbox = $('.js-check-all');
        allCheckbox.prop('checked', checkedCount === totalCount);
        form.render('checkbox');
    });
});
</script>
</body>
</html>
